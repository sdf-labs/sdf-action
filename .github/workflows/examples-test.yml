name: Test sdf-action

on:
  pull_request:

jobs:
  # dbt_init_challenge_job:
  #   runs-on: ubuntu-latest
  #   name: Run sdf push on a DBT + Snowflake workspace
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: sdf push step
  #       uses: ./ # Uses an action in the root directory
  #       id: sdf
  #       with:
  #         command: 'sdf push'
  #         workspace_dir: 'workspace/dbt_init_challenge'
  #         access_key: ${{ secrets.ACCESS_KEY }}
  #         secret_key: ${{ secrets.SECRET_KEY }}

  #         is_dbt: 'true'
  #         snowflake_account_id: ${{ secrets.SNOWFLAKE_ACCOUNT_ID }}
  #         snowflake_username: ${{ secrets.SNOWFLAKE_USERNAME }}
  #         snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
  #         snowflake_role: 'dbt_test_role'
  #         snowflake_warehouse: 'dbt_dev_wh'
  #         dbt_target: 'dev'

  #     # Use the output from the `sdf` step
  #     - name: Display the sdf output
  #       run: |
  #         echo "### SDF Run Logs ðŸªµ" >> $GITHUB_STEP_SUMMARY
  #         echo '```' >>$GITHUB_STEP_SUMMARY
  #         echo "${{ steps.sdf.outputs.log }}" >>$GITHUB_STEP_SUMMARY
  #         echo '```' >>$GITHUB_STEP_SUMMARY

  # tpch_redshift:
  #   runs-on: ubuntu-latest
  #   name: Run sdf compile on a Redshift workspace
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: sdf compile step
  #       uses: ./ # Uses an action in the root directory
  #       id: sdf
  #       with:
  #         command: 'sdf compile --show all'
  #         workspace_dir: 'workspace/tpch_redshift'

  #         aws_region: 'us-west-2'
  #         aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  #     # Use the output from the `sdf` step
  #     - name: Display the sdf output
  #       run: |
  #         echo "### SDF Run Logs ðŸªµ" >> $GITHUB_STEP_SUMMARY
  #         echo '```' >>$GITHUB_STEP_SUMMARY
  #         echo "${{ steps.sdf.outputs.log }}" >>$GITHUB_STEP_SUMMARY
  #         echo '```' >>$GITHUB_STEP_SUMMARY

  dbt_init_challenge:
    runs-on: ubuntu-latest
    name: Run sdf push on a DBT + Snowflake workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run DBT commands
        uses: mwhitaker/dbt-action@master
        with:
          dbt_command: "dbt deps && dbt compile"
          dbt_project_folder: "workspace/dbt_init_challenge"
      
      # debug step
      - name: List files in the workspace
        run: ls -la workspace/dbt_init_challenge/target

      - name: sdf push step
        uses: ./ # Uses an action in the root directory
        id: sdf
        with:
          command: 'sdf compile'
          workspace_dir: 'workspace/dbt_init_challenge'
          access_key: ${{ secrets.ACCESS_KEY }}
          secret_key: ${{ secrets.SECRET_KEY }}

          is_dbt: 'true'
          snowflake_account_id: ${{ secrets.SNOWFLAKE_ACCOUNT_ID }}
          snowflake_username: ${{ secrets.SNOWFLAKE_USERNAME }}
          snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
          snowflake_role: 'dbt_test_role'
          snowflake_warehouse: 'dbt_dev_wh'
          dbt_target: 'dev'

      # Use the output from the `sdf` step
      - name: Display the sdf output
        run: |
          echo "### SDF Run Logs ðŸªµ" >> $GITHUB_STEP_SUMMARY
          echo '```' >>$GITHUB_STEP_SUMMARY
          echo "${{ steps.sdf.outputs.log }}" >>$GITHUB_STEP_SUMMARY
          echo '```' >>$GITHUB_STEP_SUMMARY

